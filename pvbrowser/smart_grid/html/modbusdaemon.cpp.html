<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>modbusdaemon.cpp</title>
</head>
<body>
<pre>
This cpp source file is generated by pvdevelop.
It is derived from the modbus ini-file.
This is the daemon that will read modbus cyclically and write to shared memory.
Also it will wait on the mailbox for output messages.
</pre>
<hr>

<pre>
<span style="font-style: italic;color: #808080;">//</span>
<span style="font-style: italic;color: #808080;">// Modbus daemon template                                 (C) R. Lehrig 2003</span>
<span style="font-style: italic;color: #808080;">//</span>
<span style="font-style: italic;color: #808080;">//</span>
<span style="font-style: italic;color: #808080;">// Attention: this program must be run as super user</span>
<span style="font-style: italic;color: #808080;">//</span>

<span style="color: #008000;">#include &lt;stdio.h&gt;</span>
<span style="color: #008000;">#include &lt;stdlib.h&gt;</span>
<span style="color: #008000;">#include "rlmodbus.h"</span>
<span style="color: #008000;">#include "rlsharedmemory.h"</span>
<span style="color: #008000;">#include "rlmailbox.h"</span>
<span style="color: #008000;">#include "rlthread.h"</span>
<span style="color: #008000;">#include "rlcutil.h"</span>

<span style="color: #008000;">#define MODBUS_IDLETIME (4*1000)/96</span>
<span style="color: #008000;">#define SERIAL_DEVICE   "/dev/ttyS0"</span>
<span style="color: #000000;">rlModbus       modbus(</span><span style="color: #0000ff;">256</span><span style="color: #000000;">+</span><span style="color: #0000ff;">1</span><span style="color: #000000;">,rlModbus::MODBUS_RTU);</span>
<span style="color: #000000;">rlSerial       serial;</span>
<span style="color: #000000;">rlSharedMemory shm(</span><span style="color: #dd0000;">"/srv/automation/shm/modbus.shm"</span><span style="color: #000000;">,</span><span style="color: #0000ff;">2</span><span style="color: #000000;">);</span>
<span style="color: #000000;">rlMailbox      mbx(</span><span style="color: #dd0000;">"/srv/automation/mbx/modbus.mbx"</span><span style="color: #000000;">);</span>
<span style="color: #000000;">rlThread       thread;</span>
<span style="color: #000000;">rlThread       watchdog;</span>

<span style="font-style: italic;color: #808080;">// watchdog</span>
<span style="color: #800000;">static</span><span style="color: #000000;"> </span><span style="color: #800000;">char</span><span style="color: #000000;"> *av0 = </span><span style="color: #dd0000;">""</span><span style="color: #000000;">;</span>
<span style="color: #800000;">static</span><span style="color: #000000;"> </span><span style="color: #800000;">int</span><span style="color: #000000;"> watchcnt1 = </span><span style="color: #0000ff;">0</span><span style="color: #000000;">;</span>
<span style="color: #800000;">void</span><span style="color: #000000;"> *watchdogthread(</span><span style="color: #800000;">void</span><span style="color: #000000;"> *arg)</span>
<span style="color: #000000;">{</span>
<span style="color: #000000;">  </span><span style="color: #800000;">int</span><span style="color: #000000;"> cnt1 = -</span><span style="color: #0000ff;">1</span><span style="color: #000000;">;</span>

<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">while</span><span style="color: #000000;">(</span><span style="color: #0000ff;">1</span><span style="color: #000000;">)</span>
<span style="color: #000000;">  {</span>
<span style="color: #000000;">    rlsleep(</span><span style="color: #0000ff;">5000</span><span style="color: #000000;">);</span>
<span style="color: #000000;">    </span><span style="font-weight: bold;color: #000000;">if</span><span style="color: #000000;">(cnt1 == watchcnt1) </span><span style="font-weight: bold;color: #000000;">break</span><span style="color: #000000;">;</span>
<span style="color: #000000;">    cnt1 = watchcnt1;</span>
<span style="color: #000000;">  }</span>
<span style="color: #000000;">  serial.closeDevice();</span>
<span style="color: #000000;">  rlsleep(</span><span style="color: #0000ff;">100</span><span style="color: #000000;">);</span>
<span style="color: #008000;">#ifdef unix</span>
<span style="color: #000000;">  rlexec(av0);</span>
<span style="color: #008000;">#endif</span>
<span style="color: #000000;">  exit(</span><span style="color: #0000ff;">0</span><span style="color: #000000;">); </span><span style="font-style: italic;color: #808080;">// pcontrol may start me again if rlexec fails</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">return</span><span style="color: #000000;"> arg;</span>
<span style="color: #000000;">}</span>

<span style="font-style: italic;color: #808080;">// read mailbox and write to modbus</span>
<span style="color: #800000;">void</span><span style="color: #000000;"> *reader(</span><span style="color: #800000;">void</span><span style="color: #000000;"> *arg)</span>
<span style="color: #000000;">{</span>
<span style="color: #000000;">  </span><span style="color: #800000;">int</span><span style="color: #000000;"> ret,slave,function,buflen;</span>
<span style="color: #000000;">  </span><span style="color: #800000;">unsigned</span><span style="color: #000000;"> </span><span style="color: #800000;">char</span><span style="color: #000000;"> buf[</span><span style="color: #0000ff;">256</span><span style="color: #000000;">+</span><span style="color: #0000ff;">1</span><span style="color: #000000;">];</span>

<span style="color: #000000;">  mbx.clear(); </span><span style="font-style: italic;color: #808080;">// clear old messages</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">while</span><span style="color: #000000;">((buflen = mbx.read(buf,</span><span style="font-weight: bold;color: #000000;">sizeof</span><span style="color: #000000;">(buf))) &gt; </span><span style="color: #0000ff;">0</span><span style="color: #000000;">)</span>
<span style="color: #000000;">  {</span>
<span style="color: #000000;">    slave        = buf[</span><span style="color: #0000ff;">0</span><span style="color: #000000;">];</span>
<span style="color: #000000;">    function     = buf[</span><span style="color: #0000ff;">1</span><span style="color: #000000;">];</span>
<span style="color: #000000;">    thread.lock();</span>
<span style="color: #000000;">    rlsleep(MODBUS_IDLETIME);</span>
<span style="color: #000000;">    ret = modbus.write( slave, function, &amp;buf[</span><span style="color: #0000ff;">2</span><span style="color: #000000;">], buflen-</span><span style="color: #0000ff;">2</span><span style="color: #000000;">);</span>
<span style="color: #000000;">    ret = modbus.response( &amp;slave, &amp;function, buf);</span>
<span style="color: #000000;">    rlsleep(MODBUS_IDLETIME);</span>
<span style="color: #000000;">    thread.unlock();</span>
<span style="color: #000000;">    printf(</span><span style="color: #dd0000;">"mbx ret=%d slave=%d function=%d buf[2]=%d</span><span style="color: #ff00ff;">\n</span><span style="color: #dd0000;">"</span><span style="color: #000000;">,ret,slave,function,buf[</span><span style="color: #0000ff;">2</span><span style="color: #000000;">]);</span>
<span style="color: #000000;">  }</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">return</span><span style="color: #000000;"> arg;</span>
<span style="color: #000000;">}</span>

<span style="font-style: italic;color: #808080;">// read cycle on modbus</span>
<span style="color: #800000;">int</span><span style="color: #000000;"> modbusCycle(</span><span style="color: #800000;">int</span><span style="color: #000000;"> offset, </span><span style="color: #800000;">int</span><span style="color: #000000;"> slave, </span><span style="color: #800000;">int</span><span style="color: #000000;"> function, </span><span style="color: #800000;">int</span><span style="color: #000000;"> start_adr, </span><span style="color: #800000;">int</span><span style="color: #000000;"> num_register)</span>
<span style="color: #000000;">{</span>
<span style="color: #000000;">  </span><span style="color: #800000;">unsigned</span><span style="color: #000000;"> </span><span style="color: #800000;">char</span><span style="color: #000000;"> data[</span><span style="color: #0000ff;">256</span><span style="color: #000000;">+</span><span style="color: #0000ff;">1</span><span style="color: #000000;">];</span>
<span style="color: #000000;">  </span><span style="color: #800000;">int</span><span style="color: #000000;"> ret;</span>

<span style="color: #000000;">  watchcnt1++;</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">if</span><span style="color: #000000;">(watchcnt1 &gt; </span><span style="color: #0000ff;">10000</span><span style="color: #000000;">) watchcnt1 = </span><span style="color: #0000ff;">0</span><span style="color: #000000;">;</span>
<span style="color: #000000;">  rlsleep(MODBUS_IDLETIME);</span>
<span style="color: #000000;">  thread.lock();</span>
<span style="color: #000000;">  ret = modbus.request(slave, function, start_adr, num_register);</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">if</span><span style="color: #000000;">(ret &gt;= </span><span style="color: #0000ff;">0</span><span style="color: #000000;">) ret = modbus.response( &amp;slave, &amp;function, data);</span>
<span style="color: #000000;">  thread.unlock();</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">if</span><span style="color: #000000;">(ret &gt; </span><span style="color: #0000ff;">0</span><span style="color: #000000;">) shm.write(offset,data,ret);</span>
<span style="color: #000000;">  printf(</span><span style="color: #dd0000;">"cycle ret=%d slave=%d function=%d data[0]=%d</span><span style="color: #ff00ff;">\n</span><span style="color: #dd0000;">"</span><span style="color: #000000;">,ret,slave,function,data[</span><span style="color: #0000ff;">0</span><span style="color: #000000;">]);</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">return</span><span style="color: #000000;"> ret;</span>
<span style="color: #000000;">}</span>

<span style="color: #800000;">int</span><span style="color: #000000;"> main(</span><span style="color: #800000;">int</span><span style="color: #000000;"> ac, </span><span style="color: #800000;">char</span><span style="color: #000000;"> **av)</span>
<span style="color: #000000;">{</span>
<span style="color: #000000;">  </span><span style="color: #800000;">int</span><span style="color: #000000;"> offset,ret,first;</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">if</span><span style="color: #000000;">(ac &gt; </span><span style="color: #0000ff;">0</span><span style="color: #000000;">) av0 = av[</span><span style="color: #0000ff;">0</span><span style="color: #000000;">];</span>
<span style="color: #000000;">  first = </span><span style="color: #0000ff;">1</span><span style="color: #000000;">;</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">while</span><span style="color: #000000;">(serial.openDevice(SERIAL_DEVICE,B9600,</span><span style="color: #0000ff;">1</span><span style="color: #000000;">,</span><span style="color: #0000ff;">1</span><span style="color: #000000;">,</span><span style="color: #0000ff;">8</span><span style="color: #000000;">,</span><span style="color: #0000ff;">1</span><span style="color: #000000;">,rlSerial::NONE) &lt; </span><span style="color: #0000ff;">0</span><span style="color: #000000;">)</span>
<span style="color: #000000;">  {</span>
<span style="color: #000000;">    </span><span style="font-weight: bold;color: #000000;">if</span><span style="color: #000000;">(first==</span><span style="color: #0000ff;">1</span><span style="color: #000000;">) printf(</span><span style="color: #dd0000;">"could not open serial device %s</span><span style="color: #ff00ff;">\n</span><span style="color: #dd0000;">"</span><span style="color: #000000;">,SERIAL_DEVICE);</span>
<span style="color: #000000;">    first = </span><span style="color: #0000ff;">0</span><span style="color: #000000;">;</span>
<span style="color: #000000;">    rlsleep(</span><span style="color: #0000ff;">1000</span><span style="color: #000000;">);</span>
<span style="color: #000000;">  }</span>
<span style="color: #000000;">  printf(</span><span style="color: #dd0000;">"</span><span style="color: #ff00ff;">\n</span><span style="color: #dd0000;">%s starting</span><span style="color: #ff00ff;">\n</span><span style="color: #dd0000;">"</span><span style="color: #000000;">,av0);</span>
<span style="color: #000000;">  modbus.registerSerial(&amp;serial);</span>
<span style="color: #000000;">  thread.create(reader,NULL);</span>
<span style="color: #000000;">  watchdog.create(watchdogthread,NULL);</span>

<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">while</span><span style="color: #000000;">(</span><span style="color: #0000ff;">1</span><span style="color: #000000;">)</span>
<span style="color: #000000;">  {</span>
<span style="color: #000000;">    offset = </span><span style="color: #0000ff;">0</span><span style="color: #000000;">;</span>
<span style="color: #000000;">    </span><span style="font-style: italic;color: #808080;">//    modbusCycle(offset, slave, function, start_adr, num_register);</span>
<span style="color: #000000;">    ret = modbusCycle(offset,</span><span style="color: #0000ff;">1</span><span style="color: #000000;">,</span><span style="color: #0000ff;">2</span><span style="color: #000000;">,</span><span style="color: #0000ff;">0</span><span style="color: #000000;">,</span><span style="color: #0000ff;">10</span><span style="color: #000000;">);</span>
<span style="color: #000000;">    </span><span style="font-weight: bold;color: #000000;">if</span><span style="color: #000000;">(ret&gt;</span><span style="color: #0000ff;">0</span><span style="color: #000000;">) offset += ret; </span><span style="font-weight: bold;color: #000000;">else</span><span style="color: #000000;"> </span><span style="font-weight: bold;color: #000000;">continue</span><span style="color: #000000;">;</span>
<span style="color: #000000;">  }</span>

<span style="color: #000000;">  </span><span style="font-style: italic;color: #808080;">// we will never come here</span>
<span style="color: #000000;">  serial.closeDevice();</span>
<span style="color: #000000;">  </span><span style="font-weight: bold;color: #000000;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">0</span><span style="color: #000000;">;</span>
<span style="color: #000000;">}</span>
</pre></body>
</html>
